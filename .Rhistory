theme_void() +    # Removes all background and axis elements
# scale_fill_manual(
#     values = c("under.40" = "#F4E5B6",
#                "40.to.80" = "#C98293",
#                "80.to.120" = "#B4C6A6",
#                "120.or.more" = "#9D8CB2"),
#     name = "",  # Optional: specify legend title here
#     labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")  # Customize labels if needed
# ) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 0)
) +
labs(fill = "")
# Calculate the cumulative sum of the values and the midpoint for labels
data2 <- data %>%
group_by(Categoty) %>%
arrange(desc(name)) %>%  # Ensures that the order is consistent
mutate(cumulative = cumsum(value),
midpoint = cumulative - value / 2,
label = paste0(value, "%"))
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
# scale_fill_manual(
#     values = c("under.40" = "#F4E5B6",
#                "40.to.80" = "#C98293",
#                "80.to.120" = "#B4C6A6",
#                "120.or.more" = "#9D8CB2"),
#     name = "",  # Optional: specify legend title here
#     labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")  # Customize labels if needed
# ) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 0)
) +
labs(fill = "")
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
# scale_fill_manual(
#     values = c("under.40" = "#F4E5B6",
#                "40.to.80" = "#C98293",
#                "80.to.120" = "#B4C6A6",
#                "120.or.more" = "#9D8CB2"),
#     name = "",  # Optional: specify legend title here
#     labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")  # Customize labels if needed
# ) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 10)
) +
labs(fill = "")
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#F4E5B6",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#9D8CB2"),
name = "",  # Optional: specify legend title here
labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")  # Customize labels if needed
) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 10)
) +
labs(fill = "")
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#F4E5B6",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#9D8CB2"),
name = ""
# labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")  # Customize labels if needed
) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 10)
) +
labs(fill = "")
D9A7B3
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#F4E5B6",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#9D8CB2"),
name = ""
labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")  # Customize labels if needed
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#F4E5B6",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#9D8CB2"),
name = "",
labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")  # Customize labels if needed
) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 10)
) +
labs(fill = "")
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#F4E5B6",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#9D8CB2"),
name = ""
# labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")
) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 10)
) +
labs(fill = "")
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#F4E5B6",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#9D8CB2"),
name = ""
labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#F4E5B6",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#9D8CB2"),
name = "",
labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")
) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 10)
) +
labs(fill = "")
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#9D8CB2",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#F4E5B6"),
name = "",
labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")
) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 10)
) +
labs(fill = "")
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#F4E5B6",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#9D8CB2"),
name = "",
labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")
) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 10)
) +
labs(fill = "")
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#F4E5B6",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#9D8CB2"),
name = ""
# labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")
) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 10)
) +
labs(fill = "")
desired_order <- c("under.40", "40.to.80", "80.to.120", "120.or.more")
data2$name <- factor(data2$name, levels = desired_order)
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#F4E5B6",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#9D8CB2"),
name = ""
# labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")
) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 10)
) +
labs(fill = "")
# Calculate the cumulative sum of the values and the midpoint for labels
data2 <- data %>%
group_by(Categoty) %>%
arrange(desc(name)) %>%  # Ensures that the order is consistent
mutate(cumulative = cumsum(value),
midpoint = cumulative - value / 2,
label = paste0(value, "%"))
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#F4E5B6",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#9D8CB2"),
name = ""
# labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")
) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 10)
) +
labs(fill = "")
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#F4E5B6",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#9D8CB2"),
name = ""
# labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")
) +
theme(
legend.position = "bottom",
strip.text.x = element_text(size = 0)
) +
labs(fill = "")
# Create the hollow pie chart
ggplot(data2, aes(x = 2, y = value, fill = name)) +
geom_bar(stat = "identity", width = 1, color = "gray30") +
coord_polar(theta = "y") +
facet_grid(~str_to_title(Categoty)) +
geom_text(aes(y = midpoint, label = label), color = "gray20", size = 5) +  # Add labels
xlim(0.5, 2.5) +  # Adjusts the inner and outer radius to create the hollow effect
theme_void() +    # Removes all background and axis elements
scale_fill_manual(
values = c("under.40" = "#F4E5B6",
"40.to.80" = "#C98293",
"80.to.120" = "#B4C6A6",
"120.or.more" = "#9D8CB2"),
name = ""
# labels = c("Under 40", "40 to 80", "80 to 120", "120 or more")
) +
theme(
legend.position = "bottom",
strip.text.x = element_blank()
) +
labs(fill = "")
library(tidyverse)
library(spocc)
library(rgbif)
library(terra)
# plant_ext <- c(-100, -80, 12, 24)
plant_ext <- c(-100, -65, 6, 24)
plant_data <- occ(query = "Zamia prasina",
from = "gbif",
limit = 10000,
geometry = sf_bbox(plant_ext))
sf_bbox <- function(x) {
return(
terra::ext(x) %>%
as.polygons() %>%
sf::st_as_sf()
)
}
# plant_ext <- c(-100, -80, 12, 24)
plant_ext <- c(-100, -65, 6, 24)
plant_data <- occ(query = "Zamia prasina",
from = "gbif",
limit = 10000,
geometry = sf_bbox(plant_ext))
plant_data2 <- occ(query = "Zamia polymorpha",
from = "gbif",
limit = 10000,
geometry = sf_bbox(plant_ext))
plant_background <- occ(query = "Cycadales",
from = "gbif",
limit = 50000,
geometry = sf_bbox(plant_ext))
cat_df <- cat_data$gbif$data[[1]] %>%
as_tibble() %>%
filter(name %in% c("Prionailurus bengalensis (Kerr, 1792)",
"Prionailurus bengalensis bengalensis",
"Prionailurus bengalensis euptilurus (Elliot, 1871)",
"Felis bengalensis Kerr, 1792",
"Prionailurus bengalensis chinensis (Gray, 1837)",
"Prionailurus bengalensis borneoensis Brongersma, 1936",
"Prionailurus bengalensis heaneyi Groves, 1997",
"Prionailurus bengalensis javanensis (Desmarest, 1816)",
"Prionailurus bengalensis sumatranus (Horsfield, 1821)",
"Prionailurus bengalensis trevelyani Pocock, 1939",
"Prionailurus bengalensis horsfieldii (Gray, 1842)"),
!is.na(longitude),
!is.na(latitude),
year >= 1990,
coordinateUncertaintyInMeters <= 5000 | is.na(coordinateUncertaintyInMeters))
plant_df <- bind_rows(plant_data$gbif$data[[1]],
plant_data2$gbif$data[[1]]) %>%
as_tibble() %>%
filter(!is.na(longitude),
!is.na(latitude),
year >= 1990,
coordinateUncertaintyInMeters <= 5000 | is.na(coordinateUncertaintyInMeters))
plant_bg <- plant_background$gbif$data[[1]] %>%
as_tibble() %>%
filter(!is.na(longitude),
!is.na(latitude),
year >= 1990,
coordinateUncertaintyInMeters <= 5000 | is.na(coordinateUncertaintyInMeters))
plot(plant_bg$latitude ~ plant_bg$longitude,
xlim = c(-100, -80),
ylim = c(12, 24))
plot(plant_bg$latitude ~ plant_bg$longitude)
points(plant_df$latitude ~ plant_df$longitude,
# xlim = c(-100, -80),
# ylim = c(12, 24),
col = "red")
plant_points <- bind_rows(plant_df %>%
select(longitude,
latitude) %>%
mutate(species = "Zamia polymorpha",
value = 1),
plant_bg %>%
select(longitude,
latitude) %>%
mutate(species = "Zamia polymorpha",
value = 0)) %>%
relocate(species,
.before = longitude)
saveRDS(plant_points, "data/species_data_zamia_polymorpha.rds")
range(plant_points$longitude)
range(plant_points$latitude)
list.files("data/CHELSA_data/1981-2010/", pattern = "_plant.tif")
list.files("data/CHELSA_data/1981-2010/", pattern = "_plant.tif", full.names = TRUE) %>%
unlink()
list.files("data/CHELSA_data/1981-2010/", pattern = "_plant.tif", full.names = TRUE)
list.files("data/CHELSA_data/2041-2070_gfdl-esm4_ssp585/", pattern = "_plant.tif", full.names = TRUE) %>%
unlink()
list.files("data/CHELSA_data/2041-2070_gfdl-esm4_ssp585/", pattern = "_plant.tif", full.names = TRUE)
list.files("data/CHELSA_data/2071-2100_gfdl-esm4_ssp585/", pattern = "_plant.tif", full.names = TRUE)
list.files("data/CHELSA_data/2071-2100_gfdl-esm4_ssp585/", pattern = "_plant.tif", full.names = TRUE) %>%
unlink()
list.files("data/CHELSA_data/2071-2100_gfdl-esm4_ssp585/",
pattern = "_plant.tif", full.names = TRUE)
library(magrittr)
library(terra)
cat_ext <- terra::ext(c(65, 145, -10, 50))
plant_ext <- terra::ext(c(-100, -65, 6, 24))
# periods to download
periods <- c(
"1981-2010",
"2041-2070/GFDL-ESM4/ssp585",
"2071-2100/GFDL-ESM4/ssp585"
)
# variable of interest
vars <- c(
paste0("bio", 1:19)
# "gdd5",
# "pet_penman_mean",
# "pet_penman_range",
# "npp"
)
clean_name <- function(x) {
return(
tolower(gsub("/", "_", x))
)
}
dir_base <- "data/CHELSA_data"
url_base <- "https://os.zhdk.cloud.switch.ch/envicloud/chelsa/chelsa_V2/GLOBAL/climatologies/%s/bio"
for (tp in periods) {
for (vr in vars) {
# get the full url for download
url_period <- sprintf(url_base, tp)
url_full <- sprintf("%s/CHELSA_%s_%s_V.2.1.tif", url_period, vr, clean_name(tp))
# NOTE: for download just use the parent dir; then delete original
dwn_name <- sprintf("%s/%s.tif", dir_base, vr)
tryCatch(
{
download.file(url = url_full, destfile = dwn_name, method = "curl")
},
error = function(cond) {
message("Failed download: ", vr, " of ", tp)
next
}
)
# output dir base on the input period
out_dir <- file.path(dir_base, clean_name(tp))
if (!dir.exists(out_dir))
dir.create(out_dir, recursive = TRUE)
# read and mask the data
# terra::crop(
#     x = terra::rast(dwn_name),
#     y = cat_ext,
#     filename = sprintf("%s/%s_%s.tif", out_dir, vr, "cat")
# )
terra::crop(
x = terra::rast(dwn_name),
y = plant_ext,
filename = sprintf("%s/%s_%s.tif", out_dir, vr, "plant")
)
# remove the main file
unlink(dwn_name)
print(dwn_name)
}
}
