# preparing topo data for cat ---------------------------------------------
the_rast <- terra::rast("data/CHELSA_data/PCA/1981-2010/pc1_plant.tif")
plot(
c(the_rast, terra::rast("data/Topo/MSTPI_plant.tif"))
)
plot(rast(terra::rast("data/Topo/MSTPI_plant.tif")))
plot(rast(terra::rast("data/Topo/MSTPI_plant.tif")))
terra::rast("data/Topo/MSTPI_plant.tif")
plot(terra::rast("data/Topo/MSTPI_plant.tif"))
r <- terra::resample(
x = terra::rast("data/Topo/MSTPI_pl.tif"),
y = the_rast,
method = "near",
filename = "data/Topo/MSTPI_plant.tif",
names = "TPI"
)
plot(
c(the_rast, r)
)
library(tidyverse)
library(janitor)
library(terra)
library(blockCV)
library(sf)
# read models and other functions
source("R/models.R")
source("R/helper_functions.R")
#
# get climate data --------------------------------------------------------
world_map <- geodata::world(resolution = 4, path = "data")
the_ext <- terra::ext(c(-100, -74, 12, 24))
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
),
"data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
f2_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/2071-2100_gfdl-esm4_ssp585/",
pattern = "_cat.tif$",
full.names = TRUE
),
"data/Topo/MSTPI_cat.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
# projections -------------------------------------------------------------
f1_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/2041-2070_gfdl-esm4_ssp585/",
pattern = "_cat.tif$",
full.names = TRUE
),
"data/Topo/MSTPI_cat.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
tm <- Sys.time()
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_cat.tif$",
full.names = TRUE
),
"data/Topo/MSTPI_cat.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
gc
gc()
# remotes::install_github("rvalavi/myspatial")
library(tidyverse)
library(terra)
library(blockCV)
library(sf)
# read models and other functions
source("R/models.R")
source("R/helper_functions.R")
#
# get climate data --------------------------------------------------------
exc_countries <- c("MNG", "KAZ") # "KGZ"
world_map <- geodata::world(resolution = 4, path = "data")
world_map <- world_map[!world_map$GID_0 %in% exc_countries]
the_ext <- terra::ext(c(65, 145, -10, 48))
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_cat.tif$",
full.names = TRUE
),
"data/Topo/MSTPI_cat.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
# projections -------------------------------------------------------------
f1_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/2041-2070_gfdl-esm4_ssp585/",
pattern = "_cat.tif$",
full.names = TRUE
),
"data/Topo/MSTPI_cat.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
)
# plot(covar_rast)
plot(covar_rast[[1]])
ext(covar_rast)
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
)
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext)
the_ext
the_ext <- terra::ext(c(-100, -74, 12, 24))
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
# plot(covar_rast)
plot(covar_rast[[1]])
plot(world_map, add = TRUE)
the_ext <- terra::ext(c(-100, -74, 11, 24))
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
# plot(covar_rast)
plot(covar_rast[[1]])
plot(world_map, add = TRUE)
the_ext <- terra::ext(c(-100, -74, 10.8, 24))
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
# plot(covar_rast)
plot(covar_rast[[1]])
plot(world_map, add = TRUE)
the_ext <- terra::ext(c(-100, -74, 10, 24))
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
# plot(covar_rast)
plot(covar_rast[[1]])
the_ext <- terra::ext(c(-100, -74, 9, 24))
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
# plot(covar_rast)
plot(covar_rast[[1]])
the_ext <- terra::ext(c(-100, -74, 7, 24))
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
# plot(covar_rast)
plot(covar_rast[[1]])
plot(world_map, add = TRUE)
world_map <- geodata::world(resolution = 4, path = "data")
world_map[world_map$NAME_0 == "Colombia"]
world_map[world_map$NAME_0 == "Venezuela"]
#
# get climate data --------------------------------------------------------
exc_countries <- c("COL", "VEN")
world_map <- geodata::world(resolution = 4, path = "data")
world_map <- world_map[!world_map$GID_0 %in% exc_countries]
the_ext <- terra::ext(c(-100, -74, 7, 24))
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
# plot(covar_rast)
plot(covar_rast[[1]])
plot(world_map, add = TRUE)
world_map <- geodata::world(resolution = 4, path = "data")
# world_map <- world_map[!world_map$GID_0 %in% exc_countries]
the_ext <- terra::ext(c(-100, -74, 7, 24))
# world_map <- world_map[!world_map$GID_0 %in% exc_countries]
the_ext <- terra::ext(c(-100, -76.5, 7, 24))
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
# plot(covar_rast)
plot(covar_rast[[1]])
plot(world_map, add = TRUE)
# world_map <- world_map[!world_map$GID_0 %in% exc_countries]
the_ext <- terra::ext(c(-100, -77, 7, 24))
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
)
# "data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
# plot(covar_rast)
plot(covar_rast[[1]])
plot(world_map, add = TRUE)
# preparing topo data for cat ---------------------------------------------
the_rast <- terra::rast("data/CHELSA_data/PCA/1981-2010/pc1_plant.tif")
r <- terra::resample(
x = terra::rast("data/Topo/MSTPI_pl_base.tif"),
y = the_rast,
method = "near",
filename = "data/Topo/MSTPI_plant.tif",
names = "TPI"
)
plot(
c(the_rast, r)
)
#
# get climate data --------------------------------------------------------
exc_countries <- c("COL", "VEN")
world_map <- geodata::world(resolution = 4, path = "data")
# world_map <- world_map[!world_map$GID_0 %in% exc_countries]
the_ext <- terra::ext(c(-100, -77, 7, 24))
covar_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/1981-2010/",
pattern = "_plant.tif$",
full.names = TRUE
),
"data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
# plot(covar_rast)
plot(covar_rast[[1]])
plot(world_map, add = TRUE)
plot(covar_rast)
# get and clean species data ----------------------------------------------
occ_xy <- readRDS("data/species_data_zamia_polymorpha.rds") %>%
dplyr::select(longitude, latitude, value) %>%
setNames(c("x", "y", "occ")) %>%
rm_duplicates(r = covar_rast, column = "occ")
table(occ_xy$occ)
points(occ_xy$x, occ_xy$y)
points(occ_xy$x[occ_xy$occ == 1], occ_xy$y[occ_xy$occ == 1], col = "red")
# extract values ----------------------------------------------------------
species_data <- extract_value(covar_rast, occ_xy, drop_na = TRUE)
# head(model_data)
table(species_data$occ)
# select only modelling columns
model_data <- dplyr::select(species_data, -x, -y) #%>%
str(model_data)
anyNA(model_data)
#
# spatial cv --------------------------------------------------------------
data_sf <- sf::st_as_sf(species_data, coords = c("x", "y"), crs = 4326)
# final model fitting -----------------------------------------------------
# fitting the with model tuning
tm <- Sys.time()
model <- ensemble(
x = model_data,
y = "occ",
fold_ids = NULL, # random-cv tuning
models = c("GLM", "GAM", "GBM", "RF", "Maxent")
)
Sys.time() - tm
print(model)
# check the response curves
myspatial::ggResponse(
models = model,
covariates = model_data[, -1],
type = "response"
)
# predict to raster layers
tm <- Sys.time()
pred_current <- terra::predict(
object = covar_rast,
model = model,
type = "response",
cpkgs = c(
"ranger",
"dismo",
"gbm",
"mgcv",
"glmnet"
),
na.rm = TRUE,
filename = "outputs/plant/pred_current.tif",
wopt = list(names = "current"),
overwrite = TRUE
)
Sys.time() - tm
plot(pred_current, range = c(0, 1))
f2_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/2071-2100_gfdl-esm4_ssp585/",
pattern = "_plant.tif$",
full.names = TRUE
),
"data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
# get climate data --------------------------------------------------------
world_map <- geodata::world(resolution = 4, path = "data")
the_ext <- terra::ext(c(-100, -77, 7, 24))
f2_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/2071-2100_gfdl-esm4_ssp585/",
pattern = "_plant.tif$",
full.names = TRUE
),
"data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
f2_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/2071-2100_gfdl-esm4_ssp585/",
pattern = "_plant.tif$",
full.names = TRUE
),
"data/Topo/MSTPI_plant.tif"
)
)
terra::rast(
c(
list.files(
path = "data/CHELSA_data/2071-2100_gfdl-esm4_ssp585/",
pattern = "_plant.tif$",
full.names = TRUE
)
)
)
list.files(
path = "data/CHELSA_data/2071-2100_gfdl-esm4_ssp585/",
pattern = "_plant.tif$",
full.names = TRUE
)
f2_rast <- terra::rast(
c(
list.files(
path = "data/CHELSA_data/PCA/2071-2100_gfdl-esm4_ssp585/",
pattern = "_plant.tif$",
full.names = TRUE
),
"data/Topo/MSTPI_plant.tif"
)
) %>%
terra::crop(the_ext) %>%
terra::mask(world_map)
model
tm <- Sys.time()
pred_f2 <- terra::predict(
object = f2_rast,
model = model,
type = "response",
cpkgs = c(
"ranger",
"dismo",
"gbm",
"mgcv",
"glmnet"
),
na.rm = TRUE,
filename = "outputs/plant/pred_f2.tif",
wopt = list(names = "proj-2071-2100"),
overwrite = TRUE
)
